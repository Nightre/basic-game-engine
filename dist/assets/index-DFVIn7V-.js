(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function s(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(i){if(i.ep)return;i.ep=!0;const n=s(i);fetch(i.href,n)}})();class c{_x;_y;onChangeFn;get x(){return this._x}get y(){return this._y}set x(t){this._x!==t&&(this._x=t,this.onChangeFn?.())}set y(t){this._y!==t&&(this._y=t,this.onChangeFn?.())}constructor(t=0,s){this.set(t,s)}onChange(t){this.onChangeFn=t}set(t,s){let e=!1;return typeof t=="number"?s!==void 0?(this._x!==t||this._y!==s)&&(e=!0,this._x=t,this._y=s):(this._x!==t||this._y!==t)&&(e=!0,this._x=t,this._y=t):(this._x!==t._x||this._y!==t._y)&&(e=!0,this._x=t._x,this._y=t._y),e&&this.onChangeFn?.(),this}clone(){return new c(this._x,this._y)}add(t){return new c(this._x+t._x,this._y+t._y)}subtract(t){return new c(this._x-t._x,this._y-t._y)}multiplyScalar(t){return new c(this._x*t,this._y*t)}divideScalar(t){return t!==0?new c(this._x/t,this._y/t):new c(0,0)}length(){return Math.sqrt(this._x*this._x+this._y*this._y)}lengthSq(){return this._x*this._x+this._y*this._y}normalize(){const t=this.length();return t>0?this.divideScalar(t):new c(0,0)}dot(t){return this._x*t._x+this._y*t._y}distanceTo(t){return Math.sqrt(this.distanceToSq(t))}distanceToSq(t){const s=this._x-t._x,e=this._y-t._y;return s*s+e*e}limit(t){return this.lengthSq()>t*t?this.normalize().multiplyScalar(t):this.clone()}angle(){return Math.atan2(this._y,this._x)}lerp(t,s){return new c(this._x+(t._x-this._x)*s,this._y+(t._y-this._y)*s)}equals(t){return this._x===t._x&&this._y===t._y}static add(t,s){return new c(t._x+s._x,t._y+s._y)}static subtract(t,s){return new c(t._x-s._x,t._y-s._y)}static fromAngle(t){return new c(Math.cos(t),Math.sin(t))}}class w{a;b;c;d;tx;ty;constructor(t=1,s=0,e=0,i=1,n=0,a=0){this.a=t,this.b=s,this.c=e,this.d=i,this.tx=n,this.ty=a}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0,this}append(t){const s=this.a,e=this.b,i=this.c,n=this.d,a=this.tx,r=this.ty,o=t.a,l=t.b,m=t.c,f=t.d,u=t.tx,p=t.ty;return this.a=s*o+i*l,this.c=s*m+i*f,this.tx=s*u+i*p+a,this.b=e*o+n*l,this.d=e*m+n*f,this.ty=e*u+n*p+r,this}prepend(t){const s=t.a,e=t.b,i=t.c,n=t.d,a=t.tx,r=t.ty,o=this.a,l=this.b,m=this.c,f=this.d,u=this.tx,p=this.ty;return this.a=s*o+i*l,this.c=s*m+i*f,this.tx=s*u+i*p+a,this.b=e*o+n*l,this.d=e*m+n*f,this.ty=e*u+n*p+r,this}translate(t,s){return this.tx+=this.a*t+this.c*s,this.ty+=this.b*t+this.d*s,this}scale(t,s){return this.a*=t,this.b*=t,this.c*=s,this.d*=s,this}rotate(t){const s=Math.cos(t),e=Math.sin(t),i=this.a,n=this.b,a=this.c,r=this.d;return this.a=i*s+a*e,this.c=-i*e+a*s,this.b=n*s+r*e,this.d=-n*e+r*s,this}clone(){return new w(this.a,this.b,this.c,this.d,this.tx,this.ty)}copyFrom(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.tx=t.tx,this.ty=t.ty,this}invert(){const t=this.a,s=this.b,e=this.c,i=this.d,n=this.tx,a=this.ty,r=t*i-s*e;if(r===0)return this.identity();const o=1/r;return this.a=i*o,this.b=-s*o,this.c=-e*o,this.d=t*o,this.tx=(e*a-i*n)*o,this.ty=(s*n-t*a)*o,this}transformPoint(t,s){return new c(this.a*t+this.c*s+this.tx,this.b*t+this.d*s+this.ty)}transformVec2(t){return this.transformPoint(t.x,t.y)}}class y{_position=new c;_scale=new c(1,1);_rotation=0;visible=!0;zIndex=0;_childIndex=0;childIndexDirty=!1;parent=null;children=[];localTransform=new w;worldTransform=new w;isDirty=!0;_camera=null;game;get camera(){return this._camera||this.parent?.camera||this.game.mainCamera}get childIndex(){return this._childIndex}set childIndex(t){this._childIndex!=t&&(this._childIndex=t,this.parent?.setChildIndexDirty())}constructor(t){this.game=t??window.game,this._position.onChange(this.setDirty.bind(this)),this._scale.onChange(this.setDirty.bind(this))}setCamera(t){this._camera=t}get position(){return this._position}set position(t){this._position.set(t)}get scale(){return this._scale}set scale(t){this._scale.set(t)}get rotation(){return this._rotation}set rotation(t){this._rotation!==t&&(this._rotation=t,this.setDirty())}get globalPosition(){return this.updateTransform(),new c(this.worldTransform.tx,this.worldTransform.ty)}set globalPosition(t){this.position=this.globalToLocalPosition(t)}get globalScale(){this.updateTransform();const t=this.worldTransform,s=Math.sqrt(t.a*t.a+t.c*t.c),e=Math.sqrt(t.b*t.b+t.d*t.d);return new c(s,e)}set globalScale(t){this.scale=this.globalToLocalScale(t)}get globalRotation(){return this.updateTransform(),Math.atan2(this.worldTransform.c,this.worldTransform.a)}set globalRotation(t){this.rotation=this.globalToLocalRotation(t)}localToGlobalPosition(t){return this.updateTransform(),this.worldTransform.transformVec2(t)}globalToLocalPosition(t){return this.updateTransform(),this.worldTransform.clone().invert().transformVec2(t)}localToGlobalScale(t){if(!this.parent)return t.clone();this.parent.updateTransform();const s=this.parent.globalScale;return new c(s.x*t.x,s.y*t.y)}globalToLocalScale(t){if(!this.parent)return t.clone();this.parent.updateTransform();const s=this.parent.globalScale,e=s.x!==0?t.x/s.x:0,i=s.y!==0?t.y/s.y:0;return new c(e,i)}localToGlobalRotation(t){return this.parent?(this.parent.updateTransform(),this.parent.globalRotation+t):t}globalToLocalRotation(t){return this.parent?(this.parent.updateTransform(),t-this.parent.globalRotation):t}addChild(t){if(t===this||this.isDescendantOf(t))throw new Error("Cannot add child: would create a cycle");return t.parent&&t.parent.removeChild(t),t.parent=this,this.children.push(t),t.setDirty(),this.setChildIndexDirty(),this}removeChild(t){const s=this.children.indexOf(t);return s>-1&&(t.parent=null,this.children.splice(s,1),t.setDirty()),this.setChildIndexDirty(),this}setDirty(){if(!this.isDirty){this.isDirty=!0;for(const t of this.children)t.setDirty()}}setChildIndexDirty(){this.childIndexDirty=!0}updateTransform(){this.isDirty&&(this.parent&&this.parent.updateTransform(),this.localTransform.identity().translate(this._position.x,this._position.y).rotate(this._rotation).scale(this._scale.x,this._scale.y),this.parent?this.worldTransform.copyFrom(this.parent.worldTransform).append(this.localTransform):this.worldTransform.copyFrom(this.localTransform),this.isDirty=!1)}onPhysics(t){}physics(t){this.onPhysics(t),this.updateTransform();for(const s of this.children)s.physics(t)}update(t,s){this.onUpdate(t),this.updateTransform(),this.visible&&s.push(this),this.childIndexDirty&&(this.children.sort((e,i)=>e._childIndex-i._childIndex),this.childIndexDirty=!1);for(const e of this.children)e.update(t,s)}render(t){}onUpdate(t){}isDescendantOf(t){let s=this.parent;for(;s;){if(s===t)return!0;s=s.parent}return!1}destroy(){this.parent?.removeChild(this),this.children.forEach(t=>t.destroy())}}class g extends y{zoom=1;_viewMatrix=new w;limitEnabled=!1;limit={left:0,up:0,right:0,down:0};cameraPosition=new c(0,0);smoothSpeed=.15;useSmooth=!1;center;limitDiff=new c(0,0);constructor(t,s=!0){super(t),this.center=s}enableLimit(t){this.limitEnabled=t}setLimit(t,s,e,i){this.limit={left:t,up:s,right:e,down:i}}enableSmooth(t,s=5){this.useSmooth=t,this.smoothSpeed=s}getViewMatrix(){const t=this.game.scaler.logicalWidth,s=this.game.scaler.logicalHeight;if(this.updateTransform(),this._viewMatrix.copyFrom(this.worldTransform).translate(this.limitDiff.x,this.limitDiff.y),this.useSmooth){const e=this.globalToLocalPosition(this.cameraPosition);this._viewMatrix.translate(e.x,e.y)}return this._viewMatrix.invert(),this._viewMatrix.prepend(new w(this.zoom,0,0,this.zoom,0,0)),this.center&&this._viewMatrix.prepend(new w(1,0,0,1,t/2,s/2)),this._viewMatrix}screenToWorld(t){return this.getViewMatrix().clone().invert().transformVec2(t)}worldToScreen(t){return this.getViewMatrix().transformVec2(t)}onUpdate(t){this.limitDiff.set(0,0);let s=this.globalPosition;if(this.useSmooth&&(this.cameraPosition=this.cameraPosition.add(this.globalPosition.clone().subtract(this.cameraPosition).multiplyScalar(this.smoothSpeed*t)),s=this.cameraPosition),this.limitEnabled){const e=this.game.scaler.logicalWidth,i=this.game.scaler.logicalHeight,n=new c(e,i),a=s.subtract(n.multiplyScalar(.5)),r=s.add(n.multiplyScalar(.5)),o=new c(this.limit.left,this.limit.up),l=new c(this.limit.right,this.limit.down),m=l.x-o.x,f=l.y-o.y,u=new c((a.x+r.x)/2,(a.y+r.y)/2),p=new c((this.limit.left+this.limit.right)/2,(this.limit.up+this.limit.down)/2);e>m?this.limitDiff.x+=p.x-u.x:(a.x<o.x&&(this.limitDiff.x+=o.x-a.x),r.x>l.x&&(this.limitDiff.x+=l.x-r.x)),i>f?this.limitDiff.y+=p.y-u.y:(a.y<o.y&&(this.limitDiff.y+=o.y-a.y),r.y>l.y&&(this.limitDiff.y+=l.y-r.y))}}}function v(h){return{all:h=h||new Map,on:function(t,s){var e=h.get(t);e?e.push(s):h.set(t,[s])},off:function(t,s){var e=h.get(t);e&&(s?e.splice(e.indexOf(s)>>>0,1):h.set(t,[]))},emit:function(t,s){var e=h.get(t);e&&e.slice().map(function(i){i(s)}),(e=h.get("*"))&&e.slice().map(function(i){i(t,s)})}}}class S{cache=new Map;nameMap=new Map;emitter=v();on=this.emitter.on;off=this.emitter.off;async loadImage(t,s){if(this.cache.has(t))return this.cache.get(t);const e=t.endsWith(".svg");return new Promise((i,n)=>{const a=new Image;a.onload=()=>{let r=a;if(e){const o=document.createElement("canvas");o.width=a.width,o.height=a.height,o.getContext("2d").drawImage(a,0,0),r=o}this.cache.set(t,r),s&&this.nameMap.set(s,t),this.emitter.emit("load",{url:t,name:s,asset:r}),i(r)},a.onerror=r=>n(r),a.src=t})}async loadAudio(t,s){return this.cache.has(t)?this.cache.get(t):new Promise((e,i)=>{const n=new Audio;n.oncanplaythrough=()=>{this.cache.set(t,n),s&&this.nameMap.set(s,t),this.emitter.emit("load",{url:t,name:s,asset:n}),e(n)},n.onerror=a=>i(a),n.src=t,n.load()})}async loadJSON(t,s){if(this.cache.has(t))return this.cache.get(t);const i=await(await fetch(t)).json();return this.cache.set(t,i),s&&this.nameMap.set(s,t),this.emitter.emit("load",{url:t,name:s,asset:i}),i}async loadXML(t,s){if(this.cache.has(t))return this.cache.get(t);const i=await(await fetch(t)).text(),a=new DOMParser().parseFromString(i,"application/xml");return this.cache.set(t,a),s&&this.nameMap.set(s,t),this.emitter.emit("load",{url:t,name:s,asset:a}),a}async loadText(t,s){if(this.cache.has(t))return this.cache.get(t);const i=await(await fetch(t)).text();return this.cache.set(t,i),s&&this.nameMap.set(s,t),this.emitter.emit("load",{url:t,name:s,asset:i}),i}guessType(t){const s=t.split("?")[0].split(".").pop()?.toLowerCase()??"";return["png","jpg","jpeg","gif","webp","svg"].includes(s)?"image":["mp3","wav","ogg","m4a"].includes(s)?"audio":s==="json"?"json":["xml"].includes(s)?"xml":(["txt","csv","md","log"].includes(s),"text")}async loadAll(t){let s=0;const e=t.length,i=await Promise.all(t.map(async({url:n,name:a,type:r})=>{const o=r??this.guessType(n);let l;switch(o){case"image":l=this.loadImage(n,a);break;case"audio":l=this.loadAudio(n,a);break;case"json":l=this.loadJSON(n,a);break;case"xml":l=this.loadXML(n,a);break;case"text":default:l=this.loadText(n,a);break}const m=await l;return s++,this.emitter.emit("progress",s/e),m}));return this.emitter.emit("complete"),new Map(t.map(({url:n},a)=>[n,i[a]]))}get(t){if(this.cache.has(t))return this.cache.get(t);if(this.nameMap.has(t)){const s=this.nameMap.get(t);return this.cache.get(s)}}clear(){this.cache.clear(),this.nameMap.clear()}}class L{game;scaler;emitter=v();on=this.emitter.on;off=this.emitter.off;mouseScreenPosition=new c;keysDown=new Set;keysDownLastFrame=new Set;buttonsDown=new Set;buttonsDownLastFrame=new Set;handleMouseMove;handleKeyDown;handleKeyUp;handleMouseDown;handleMouseUp;handleClick;handleWheel;handleContextMenu;constructor(t){this.game=t,this.scaler=t.scaler,this.attachEventListeners()}getMouseWorldPosition(){return this.game.mainCamera.screenToWorld(this.mouseScreenPosition)}attachEventListeners(){const t=this.scaler.canvas;t.addEventListener("mousemove",this.handleMouseMove=s=>{const e=new c(s.clientX,s.clientY),i=this.scaler.cssToScreen(e);this.mouseScreenPosition.set(i),this.emitter.emit("mousemove",{position:this.mouseScreenPosition.clone(),event:s})}),window.addEventListener("keydown",this.handleKeyDown=s=>{this.keysDown.has(s.code)||(this.keysDown.add(s.code),this.emitter.emit("keydown",{code:s.code,event:s}))}),window.addEventListener("keyup",this.handleKeyUp=s=>{this.keysDown.delete(s.code),this.emitter.emit("keyup",{code:s.code,event:s})}),t.addEventListener("mousedown",this.handleMouseDown=s=>{this.buttonsDown.add(s.button),this.emitter.emit("mousedown",{position:this.getMouseWorldPosition(),button:s.button,event:s})}),t.addEventListener("mouseup",this.handleMouseUp=s=>{this.buttonsDown.delete(s.button),this.emitter.emit("mouseup",{position:this.getMouseWorldPosition(),button:s.button,event:s})}),t.addEventListener("click",this.handleClick=s=>{this.emitter.emit("click",{position:this.getMouseWorldPosition(),button:s.button,event:s})}),t.addEventListener("wheel",this.handleWheel=s=>{s.preventDefault(),this.emitter.emit("wheel",{event:s})}),t.addEventListener("contextmenu",this.handleContextMenu=s=>{s.preventDefault(),this.emitter.emit("contextmenu",{position:this.getMouseWorldPosition(),event:s})})}update(){this.keysDownLastFrame=new Set(this.keysDown),this.buttonsDownLastFrame=new Set(this.buttonsDown)}isKeyDown(t){return this.keysDown.has(t)}isKeyUp(t){return!this.keysDown.has(t)}wasKeyPressed(t){return this.keysDown.has(t)&&!this.keysDownLastFrame.has(t)}wasKeyReleased(t){return!this.keysDown.has(t)&&this.keysDownLastFrame.has(t)}isButtonDown(t){return this.buttonsDown.has(t)}isButtonUp(t){return!this.buttonsDown.has(t)}wasButtonPressed(t){return this.buttonsDown.has(t)&&!this.buttonsDownLastFrame.has(t)}wasButtonReleased(t){return!this.buttonsDown.has(t)&&this.buttonsDownLastFrame.has(t)}getMouseLocal(t){return t.globalToLocalPosition(this.getMouseWorldPosition())}getAxis(t,s){let e=0;return this.isKeyDown(s)&&(e+=1),this.isKeyDown(t)&&(e-=1),e}getVector(t,s,e,i){const n=this.getAxis(t,s),a=this.getAxis(e,i);return new c(n,a).normalize()}destroy(){const t=this.scaler.canvas;t.removeEventListener("mousemove",this.handleMouseMove),window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),t.removeEventListener("mousedown",this.handleMouseDown),t.removeEventListener("mouseup",this.handleMouseUp),t.removeEventListener("click",this.handleClick),t.removeEventListener("wheel",this.handleWheel),t.removeEventListener("contextmenu",this.handleContextMenu),this.emitter.all.clear(),this.keysDown.clear(),this.keysDownLastFrame.clear(),this.buttonsDown.clear(),this.buttonsDownLastFrame.clear()}}var _=(h=>(h[h.IGNORE=0]="IGNORE",h[h.EXPAND=1]="EXPAND",h))(_||{});class P{canvas;width;height;logicalWidth;logicalHeight;physicsWidth;physicsHeight;canvasWidth;canvasHeight;dpr=1;mode;scale=1;offsetX=0;offsetY=0;constructor(t,s,e,i=1){this.canvas=t,this.width=s,this.height=e,this.mode=i,this.logicalWidth=s,this.logicalHeight=e,this.physicsWidth=s,this.physicsHeight=e,this.canvasWidth=s,this.canvasHeight=e,this.resize(),window.addEventListener("resize",()=>this.resize())}setMode(t){this.mode=t,this.resize()}resize(){const t=this.canvas.parentElement||document.body,s=t.clientWidth,e=t.clientHeight;this.dpr=window.devicePixelRatio||1;const i=this.width/this.height,n=s/e;switch(this.canvas.style.width=s+"px",this.canvas.style.height=e+"px",this.canvasHeight=e,this.canvasWidth=s,this.physicsWidth=Math.round(s*this.dpr),this.physicsHeight=Math.round(e*this.dpr),this.mode){case 1:n>i?(this.logicalHeight=this.height,this.logicalWidth=this.height*n):(this.logicalWidth=this.width,this.logicalHeight=this.width/n);break;case 0:this.logicalWidth=this.physicsWidth,this.logicalHeight=this.physicsHeight;break}this.canvas.width=this.physicsWidth,this.canvas.height=this.physicsHeight;const a=this.physicsWidth/this.logicalWidth,r=this.physicsHeight/this.logicalHeight;this.scale=Math.min(a,r);const o=this.width*this.scale,l=this.height*this.scale;this.offsetX=(this.physicsWidth-o)/2,this.offsetY=(this.physicsHeight-l)/2}cssToScreen(t){const s=this.canvas.getBoundingClientRect(),e=t.x-s.left,i=t.y-s.top,n=e*this.dpr,a=i*this.dpr,r=n/this.scale,o=a/this.scale;return new c(r,o)}getContext(){const t=this.canvas.getContext("2d");return t&&(t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high"),t}}class C{ctx;lastTime=0;stage;renderQueue=[];mainCamera=new g(this);alive=!0;assets=new S;input;scaler;constructor(){this.stage=new y(this),window.game=this}setMainCamera(t){this.mainCamera=t}start(t){this.scaler=new P(t.canvas,t.width,t.height,t.scale),this.input=new L(this),this.ctx=this.scaler.getContext(),this.lastTime=performance.now(),this.loop(this.lastTime)}loop(t){if(!this.ctx||!this.scaler)return;const s=(t-this.lastTime)/1e3;this.lastTime=t,this.renderQueue=[],this.input.update(),this.stage.update(s,this.renderQueue),this.stage.physics(s),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.renderQueue.sort((e,i)=>e.zIndex-i.zIndex);for(const e of this.renderQueue){this.ctx.save();const i=e.camera;let n;i?n=i.getViewMatrix().clone().append(e.worldTransform):n=e.worldTransform;const a=n,o=this.scaler.scale;this.ctx.setTransform(a.a*o,a.b*o,a.c*o,a.d*o,a.tx*o,a.ty*o),e.render(this.ctx),this.ctx.restore()}this.alive&&requestAnimationFrame(e=>this.loop(e))}destroy(){this.alive=!1,this.stage&&this.stage.destroy()}changeStage(t){this.stage.destroy(),this.stage=t}}const b=(h,t,s,e,i)=>{i=i??window.game;const n=i.assets.get(t);h.drawImage(n,0,0)};class D extends y{offset=0;onUpdate(t){this.childIndex=this.globalPosition.y+this.offset}}class W extends D{speed=100;offset=32;constructor(t){super(t);const s=new g(t);s.position.set(16,16),s.setLimit(0,0,2e3,2e3),s.enableLimit(!0),s.enableSmooth(!0,3),this.addChild(s),t.setMainCamera(s)}render(t){t.drawImage(M.get("player"),0,0)}onUpdate(t){const s=F.getVector("KeyA","KeyD","KeyW","KeyS").normalize();this.position=this.position.add(s.multiplyScalar(t*this.speed)),super.onUpdate(t)}}class E extends y{onUpdate(t){this.position=this.game.input.getMouseLocal(this.parent)}render(t){b(t,"player")}}class I extends D{offset=58;render(t){b(t,"tree")}}class k extends y{render(t){t.fillStyle="#000",t.font="16px Arial",t.textBaseline="top",t.fillText("WASD to move",10,10)}}const d=new C;d.start({canvas:document.getElementById("canvas"),width:600,height:600,scale:_.EXPAND});const M=d.assets,F=d.input;await M.loadAll([{url:"./vite.svg",name:"player"},{url:"./tree.svg",name:"tree"}]);const x=new y(d);d.stage.addChild(x);const H=new W(d);x.addChild(H);d.stage.addChild(new E(d));for(let h=0;h<1e3;h++){const t=new I(d);t.position.set(Math.random()*2e3,Math.random()*2e3),x.addChild(t)}const A=new g(d,!1),T=new k(d);T.setCamera(A);d.stage.addChild(T);
